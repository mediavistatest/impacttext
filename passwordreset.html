<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CentralMessage | Reset Password</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="font-awesome/css/font-awesome.css" rel="stylesheet">
	<link href="css/animate.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<link href="css/custom.css" rel="stylesheet">
</head>
<body class="gray-bg">
	<div class="middle-box text-center loginscreen  animated fadeInDown">
		<div>
			<h1 class="logo-name"><img src="img/login_logo.png" class="img-responsive"></h1>
		</div>
		<h2 id="reset-password-title">Fill the form below to reset your password.</h2>
		<h2 id="reset-password-error-title">Please check the URL form the reset password email and try again.</h2>
		<div id="reset-password-success">
			<h2>You successfully reset your password.</h2><br />
			<a href="/login.html" class="btn btn-primary block full-width m-b">Click here to login</a>
		</div>
		<br>
		<form class="m-t" role="form" name="reset_password_form" id="reset-password-form" onsubmit="return false;">
			<div class="form-group">
				<input type="text" class="form-control" placeholder="Username" name="username" required="" autocomplete="off">
				<small class="error error-username-empty">Please enter your username.</small>
			</div>
			<div class="form-group">
				<input type="password" class="form-control" placeholder="Password" name="password" required="" autocomplete="off">
				<small class="error error-password-empty">Please enter a new password.</small>
			</div>
			<div class="form-group">
				<input type="password" class="form-control" placeholder="Confirm password" name="password_verify" required="" autocomplete="off">
				<small class="error error-password-verify-empty">Please confirm your new password.</small>
				<small class="error error-password-verify">Password and Confirm password did not match.</small>
			</div>
			<button type="button" id="reset-btn" class="btn btn-primary block full-width m-b" onclick="resetPassword()">Reset</button>
			<small class="error error-key">Could not reset password. Please check the URL form the reset password email and try again.</small>
			<small class="error error-reset">Could not reset password. Please try again.</small>
		</form>
		<br><br>
		<p class="m-t"> <small>&copy;  2015 Impact Telecom. All rights reserved.</small> </p>
	</div>
	<!-- Mainly scripts -->
	<script src="js/jquery/jquery-2.1.1.min.js"></script>
	<script src="js/bootstrap/bootstrap.min.js"></script>
	<script type="text/javascript">
		function getApiUrl(){
			var result = '';
			result = "http://tlsionweb01.excel.com/mercury/cmp/";
			if ((window.location.href.indexOf('xchangetel.impacttext.com') > -1) || (window.location.href.indexOf('portal.centralmessage.com') > -1)) {
				result = 'http://api.impacttext.com/';
			}
			return result;
		}

		function resetPassword(){
			var valid = true;

			$('.form-control, #reset-btn').prop('disabled', true);

			var $errors = $('small.error');
			if($errors.length > 0) $errors.hide();

			$('input.invalid').removeClass('invalid');

			var $username = $('input[name="username"]');
			var username = $username.val();
			var $password = $('input[name="password"]');
			var password = $password.val();
			var $passwordVerify = $('input[name="password_verify"]');
			var passwordVerify = $passwordVerify.val();

			// Check for empty username
			if(username == ''){
				$username.addClass('invalid');
				$('.error-username-empty').show();
				valid = false;
			}

			// Check for empty password
			if(password == ''){
				$password.addClass('invalid');
				$('.error-password-empty').show();
				valid = false;
			}

			// Check for empty confirmation password
			if(passwordVerify == ''){
				$passwordVerify.addClass('invalid');
				$('.error-password-verify-empty').show();
				valid = false;
			}

			// Check if passwords match
			if(password != '' && passwordVerify != '' && password != passwordVerify){
				$password.addClass('invalid');
				$passwordVerify.addClass('invalid');
				$('.error-password-verify').show();
				valid = false;
			}

			// Get and check key form URL
			var key = window.location.hash.substr(1);
			if(key == ''){
				// this should not happen
				$('.error-key').show();
				valid = false;
			}

			if(valid){
				var url = getApiUrl();
				$.post(url + "user_passwordreset", {
					user: username,
					key: key,
					newpassword: password,
					newpasswordverify: passwordVerify
				}, function(data){
					if (data == null || typeof data.apicode == 'undefined') {
						$('.error-reset').show();
						$('.form-control, #reset-btn').prop('disabled', false);
					}
					if (data.apicode == 0) {
						$('#reset-password-form, #reset-password-title').hide();
						$('#reset-password-success').show();
					}else{
						$('.error-reset').show();
						$('.form-control, #reset-btn').prop('disabled', false);
					}
				});
			}else{
				$('.form-control, #reset-btn').prop('disabled', false);
			}
		}

		$(document).ready(function(){
			var key = window.location.hash.substr(1);
			if(key == ''){
				$('#reset-password-form, #reset-password-title').hide();
				$('#reset-password-error-title').show();
				$('.form-control, #reset-btn').prop('disabled', true);
			}else{
				$('#reset-password-form, #reset-password-title').show();
				$('#reset-password-error-title').hide();
				$('.form-control, #reset-btn').prop('disabled', false);
			}
		});
	</script>
</body>
</html>